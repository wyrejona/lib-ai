"""
STRICT RAG system with comprehensive direct answers including definitions
"""
import re
import logging
from typing import List, Dict, Any
import numpy as np

logger = logging.getLogger(__name__)

# COMPREHENSIVE DIRECT ANSWER DATABASE WITH DEFINITIONS
DIRECT_ANSWERS = {
    # ============ DEFINITIONS ============
    'what is plagiarism': "Plagiarism is presenting others' ideas, works, or statements as your own without proper acknowledgment. It's academic dishonesty with serious consequences.\n\nTypes:\n1. Direct plagiarism - Copying text word-for-word without quotation marks or citation\n2. Self-plagiarism - Reusing your own previously submitted work without permission\n3. Mosaic plagiarism - Mixing your words with copied phrases without proper citation\n4. Accidental plagiarism - Failing to cite sources correctly, even unintentionally",
    
    'what is referencing': "Referencing is acknowledging and supporting your ideas during research.\n\nTwo elements:\n1. Citation: A brief acknowledgment within the text showing where information was taken from\n2. Reference: A full bibliographic description of the source, listed at the end of the document\n\nWhy reference?\nâ€¢ Shows how your argument relates to existing research\nâ€¢ Properly credits originators of ideas\nâ€¢ Demonstrates your ability to find and use sources\nâ€¢ Avoids plagiarism (academic dishonesty)",
    
    'what is citation': "Citation is a brief acknowledgment within the text showing where information was taken from. Example: (Kumar, 2021) or Kumar (2021) states...\n\nA citation points to the full reference in the reference list at the end of the document.",
    
    'what is turnitin': "Turnitin is anti-plagiarism software used by University of Embu to detect and prevent plagiarism.\n\nKey Features:\n1. Originality Check: Compares texts with academic papers, books, websites, previous submissions\n2. Similarity Reports: Shows percentage similarity with color-coded matches\n3. Citation Assistance: Helps identify missing citations\n4. GradeMark: Allows instructors to provide online feedback\n5. Integration: Works with learning management systems like Moodle",
    
    'what is apa': "APA (American Psychological Association) 7th Edition is the referencing style used by University of Embu.\n\nKey APA rules:\nâ€¢ In-text: (Author, Year) or Author (Year)\nâ€¢ Reference list: Alphabetical by author's last name\nâ€¢ Book titles: Italicized\nâ€¢ Article titles: Sentence case, not italicized\nâ€¢ Journal titles: Italicized, title case\nâ€¢ Use 'et al.' for 3+ authors in citations",
    
    'what is opac': "OPAC (Online Public Access Catalogue) is an electronic catalogue that allows users to search the library's holdings online.\n\nWhat you can do with OPAC:\nâ€¢ Search books by title, author, subject, or keyword\nâ€¢ Check availability status (on shelf or on loan)\nâ€¢ View call numbers and location\nâ€¢ Reserve or renew items (where enabled)\nâ€¢ Find materials quickly without assistance",
    
    'what is library circulation': "Library circulation refers to the process of managing the lending and returning of library materials to users.\n\nKey circulation activities:\nâ€¢ Issuing (borrowing) library materials\nâ€¢ Receiving returned items\nâ€¢ Renewing borrowed materials\nâ€¢ Reserving (holding) items for users\nâ€¢ Managing overdue items and fines\nâ€¢ Updating borrower records\n\nEnsures fair access and proper tracking of library resources.",
    
    'what is e-resource': "E-resources (electronic resources) are digital information materials accessed via internet or library network.\n\nTypes include:\nâ€¢ E-journals: Digital scholarly journals (research articles, reviews)\nâ€¢ E-books: Digital books readable online or downloadable\nâ€¢ Online databases: Organized collections of journal articles, e-books, reports, theses\nâ€¢ Digital theses & dissertations: In University repository\nâ€¢ Reports, newspapers, reference tools\n\nFeatures: Accessible anytime, anywhere with internet; Searchable text; No physical wear.",
    
    'what is myloft': "MyLOFT is a mobile app for accessing University of Embu's electronic resources.\n\nFeatures:\nâ€¢ Access to all subscribed e-resources databases\nâ€¢ Journals, databases, e-books\nâ€¢ Past exam papers (MyLOFT exclusive)\nâ€¢ Research databases\nâ€¢ Digital library collections\n\nDownload:\nâ€¢ Android: https://play.google.com/store/apps/details?id=com.eclat.myloft\nâ€¢ iOS: https://apps.apple.com/in/app/myloft/id1247428589",
    
    'what is library classification': "Library classification is how books are organized on shelves. University of Embu uses Library of Congress (LC) Classification Scheme.\n\nOrganization by floor:\nâ€¢ Ground Floor (A-L): General works, Philosophy, History, Social Sciences, Education\nâ€¢ First Floor (J-K): Political Science, Law\nâ€¢ Second Floor (Q-Z): Science, Medicine, Agriculture, Technology, Military Science\n\nEach book has a call number (e.g., QA76.73) for easy location.",
    
    'what is academic integrity': "Academic integrity means honest and responsible scholarship.\n\nUniversity of Embu Policy:\nâ€¢ Plagiarism is academic misconduct\nâ€¢ All work must be original or properly cited\nâ€¢ Students must understand and avoid plagiarism\nâ€¢ Penalties range from failing assignment to expulsion\n\nIt's fundamental to university education and research credibility.",
    
    'what is similarity report': "A similarity report is generated by Turnitin showing how much of a submitted work matches existing sources.\n\nInterpretation:\nâ€¢ Green (0-24%): Usually acceptable with proper citation\nâ€¢ Yellow (25-49%): Review carefully, may need revision\nâ€¢ Orange (50-74%): Significant issues, likely needs revision\nâ€¢ Red (75-100%): Major plagiarism concerns\n\nNote: Low percentage doesn't guarantee no plagiarism; high percentage doesn't always mean plagiarism (properly cited quotes).",
    
    'what is reference list': "A reference list is a complete list of all sources cited in a document, placed at the end.\n\nAPA 7th Edition rules:\nâ€¢ Alphabetical by author's last name\nâ€¢ Hanging indent (first line flush left, others indented)\nâ€¢ Double-spaced\nâ€¢ Title 'References' centered at top\nâ€¢ Includes full bibliographic details for each source",
    
    'what is in-text citation': "In-text citation is a brief acknowledgment within the body of your work.\n\nAPA examples:\nâ€¢ One author: (Kumar, 2021) or Kumar (2021) states...\nâ€¢ Two authors: (Achieng & Otieno, 2020)\nâ€¢ Three or more: (Mwangi et al., 2022)\nâ€¢ Direct quotes: (Kumar, 2021, p. 45)\nâ€¢ Page numbers required for direct quotes",
    
    'what is circulation desk': "The circulation desk is the main service point where users interact with library staff for borrowing-related services.\n\nServices offered:\nâ€¢ Book borrowing and returns\nâ€¢ Membership registration and verification\nâ€¢ Renewals and reservations\nâ€¢ Overdue fine inquiries and payments\nâ€¢ User guidance on locating materials\nâ€¢ Reporting lost or damaged items\n\nActs as the link between users and library collections.",
    
    'what is open access': "Open Access means free, unrestricted access to research articles, books, and data without login or payment.\n\nTop Open Access databases:\n1. DOAJ (Directory of Open Access Journals)\n2. CORE (Multidisciplinary)\n3. BASE (Bielefeld Academic Search Engine)\n4. arXiv (Physics, Math, Computer Science)\n5. PubMed Central (Medicine, Life Sciences)",
    
    # ============ BORROWING RULES ============
    'how many books can undergraduate students borrow': "Undergraduate students can borrow up to 3 books for 14 days, with 1 renewal allowed. Overdue fine: Ksh 5 per book per day.",
    'how many books can postgraduate students borrow': "Postgraduate students can borrow up to 6 books for 30 days, with 1 renewal allowed. Overdue fine: Ksh 5 per book per day.",
    'how many books can academic staff borrow': "Academic staff can borrow up to 6 books for 90 days, with 1 renewal allowed. Overdue fine: Ksh 5 per book per day.",
    'how many books can non-academic staff borrow': "Non-academic staff can borrow up to 3 books for 30 days, with 1 renewal allowed. Overdue fine: Ksh 5 per book per day.",
    'how many books can part-time lecturers borrow': "Part-time lecturers can borrow up to 6 books for 30 days, with 1 renewal allowed. Overdue fine: Ksh 5 per book per day.",
    
    'undergraduate borrowing': "3 books maximum, 14-day loan period, 1 renewal allowed, Ksh 5 per day fine.",
    'postgraduate borrowing': "6 books maximum, 30-day loan period, 1 renewal allowed, Ksh 5 per day fine.",
    'academic staff borrowing': "6 books maximum, 90-day loan period, 1 renewal allowed, Ksh 5 per day fine.",
    'non-academic staff borrowing': "3 books maximum, 30-day loan period, 1 renewal allowed, Ksh 5 per day fine.",
    'part-time lecturers borrowing': "6 books maximum, 30-day loan period, 1 renewal allowed, Ksh 5 per day fine.",
    
    # Generic borrowing questions
    'how many books can i borrow': "Borrowing limits depend on your category:\nâ€¢ Undergraduate: 3 books for 14 days\nâ€¢ Postgraduate: 6 books for 30 days\nâ€¢ Academic staff: 6 books for 90 days\nâ€¢ Non-academic staff: 3 books for 30 days\nâ€¢ Part-time lecturers: 6 books for 30 days\nAll categories: 1 renewal allowed, Ksh 5 per day fine.",
    
    'borrowing limits': "â€¢ Undergraduate: 3 books, 14 days\nâ€¢ Postgraduate: 6 books, 30 days\nâ€¢ Academic staff: 6 books, 90 days\nâ€¢ Non-academic staff: 3 books, 30 days\nâ€¢ Part-time lecturers: 6 books, 30 days",
    
    'loan period': "â€¢ Undergraduate: 14 days\nâ€¢ Postgraduate: 30 days\nâ€¢ Academic staff: 90 days\nâ€¢ Non-academic staff: 30 days\nâ€¢ Part-time lecturers: 30 days",
    
    # ============ FINES & OVERDUES ============
    'what is the fine for overdue books': "Overdue fines: Ksh 5 per book per day, starting immediately after due date. All user categories have the same fine rate.",
    'overdue fines': "Ksh 5 per item per day. Fines start accruing immediately after due date. Daily accumulation until item returned.",
    'fines': "Fine rate: Ksh 5 per item per day. Starts immediately after due date. Two reasons for fines: Overdue items only.",
    'overdue': "Accounts with overdue items are automatically locked. Cannot borrow new items while overdue items exist. To unlock: Return all overdue items AND pay all accrued fines.",
    
    # ============ LIBRARY HOURS ============
    'what time does the library open': "Library hours:\nâ€¢ Monday-Friday: 07:30â€“22:00\nâ€¢ Saturday: 09:00â€“15:00\nâ€¢ Sunday: 13:45â€“18:00",
    'library hours': "Opening hours:\nâ€¢ Mon-Fri: 07:30â€“22:00\nâ€¢ Saturday: 09:00â€“15:00\nâ€¢ Sunday: 13:45â€“18:00",
    'when does the library open': "Opens:\nâ€¢ Mon-Fri: 07:30\nâ€¢ Saturday: 09:00\nâ€¢ Sunday: 13:45",
    'library closing time': "Closes:\nâ€¢ Mon-Fri: 22:00\nâ€¢ Saturday: 15:00\nâ€¢ Sunday: 18:00",
    
    # ============ APA REFERENCING ============
    'how do i reference using apa format': "University of Embu uses APA 7th Edition.\n\nIn-text citations:\nâ€¢ One author: (Kumar, 2021)\nâ€¢ Two authors: (Achieng & Otieno, 2020)\nâ€¢ Three or more: (Mwangi et al., 2022)\nâ€¢ Direct quotes: (Kumar, 2021, p. 45)\n\nReference list examples:\nâ€¢ Book: Kumar, Ranjit. (2021). *Research methodology: A step-by-step guide for beginners*. SAGE.\nâ€¢ Journal: Tenopir, Carol. (2020). Academic reading patterns in the digital age. *Journal of Academic Librarianship*, 46(4), 102â€“110.\nâ€¢ Website: University of Embu Library. (2023). *Library services guide*. https://library.embuni.ac.ke/services/",
    
    'apa referencing': "APA 7th Edition is used at University of Embu. Formatting rules:\n1. Reference list: Alphabetical by author, hanging indent, double-spaced\n2. Book titles: Italicized\n3. Article titles: Sentence case, not italicized\n4. Journal titles: Italicized, title case\n5. Use 'et al.' for 3+ authors in citations",
    
    'how to cite in apa': "APA citation examples:\nâ€¢ (Author, Year) for in-text\nâ€¢ Author, A. A. (Year). Title. Publisher. for references\nâ€¢ Use 'et al.' for works with 3+ authors after first mention",
    
    # ============ PLAGIARISM & TURNITIN ============
    'plagiarism software': "Turnitin is the anti-plagiarism software used by University of Embu.\n\nKey features:\n1. Originality Check: Compares with billions of sources\n2. Similarity Reports: Shows percentage and highlights matches\n3. Citation Assistance: Suggests proper referencing\n4. GradeMark: Online feedback from instructors\n5. Integration: Works with Moodle, Canvas, Blackboard",
    
    'turnitin': "Turnitin is anti-plagiarism software that:\n1. Detects similarity between submitted work and existing sources\n2. Generates similarity reports with color coding\n3. Helps identify missing citations\n4. Provides evidence for academic integrity cases\n5. Used worldwide in universities",
    
    'how does turnitin work': "Turnitin process:\n1. Submission: Students upload assignments\n2. Comparison: System checks against internet, academic papers, previous submissions\n3. Report: Generates similarity percentage\n4. Review: Students and instructors review matches\n5. Revision: Students can revise before final submission",
    
    'anti-plagiarism software': "University of Embu uses Turnitin to ensure academic integrity. It compares texts with:\nâ€¢ Academic papers and journals\nâ€¢ Books and publications\nâ€¢ Websites and online content\nâ€¢ Previously submitted student papers",
    
    'similarity report': "Turnitin similarity reports:\nâ€¢ Green (0-24%): Usually acceptable with proper citation\nâ€¢ Yellow (25-49%): Review carefully\nâ€¢ Orange (50-74%): Significant issues\nâ€¢ Red (75-100%): Major plagiarism concerns\nNote: Low percentage doesn't guarantee no plagiarism",
    
    # ============ E-RESOURCES & MYLOFT ============
    'how do i access e-resources': "Access e-resources via:\n1. MyLOFT app (download from Google Play or App Store)\n2. Library website: https://library.embuni.ac.ke/eresources/\n3. University login required for subscribed resources\n\nPast exam papers are ONLY available in MyLOFT app under E-resources â†’ Exam Past papers.",
    
    'past exam papers': "Past exam papers access:\n1. Download MyLOFT app\n2. Select 'University of Embu, Kenya'\n3. Login with registered email\n4. Tap E-resources â†’ Exam Past papers\n5. Search by paper code (e.g., LIS 215)",
    
    'myloft': "MyLOFT app features:\nâ€¢ Access all subscribed e-resources\nâ€¢ Journals, databases, e-books\nâ€¢ Past exam papers (exclusive to MyLOFT)\nâ€¢ Research databases\nâ€¢ Digital library collections\n\nDownload links:\nâ€¢ Android: https://play.google.com/store/apps/details?id=com.eclat.myloft\nâ€¢ iOS: https://apps.apple.com/in/app/myloft/id1247428589",
    
    'e-resources': "Electronic resources include:\nâ€¢ E-journals: ScienceDirect, JSTOR, SpringerLink, IEEE Xplore\nâ€¢ E-books: EBSCO, ProQuest, Springer, Elsevier\nâ€¢ Online databases: Journal articles, research reports, theses\nâ€¢ Digital theses: https://repository.embuni.ac.ke\nâ€¢ Open Access databases: DOAJ, CORE, arXiv, PubMed Central",
    
    # ============ MEMBERSHIP & ACCESS ============
    'how do i join the library': "Library membership:\nâ€¢ Available to: University of Embu students (current), staff (current), alumni\nâ€¢ Requirements: Valid University of Embu ID card\nâ€¢ Note: No public or external membership available\nâ€¢ Alumni must have valid alumni identification",
    
    'library membership': "Who can join:\nâ€¢ Current University of Embu students\nâ€¢ Current University of Embu staff\nâ€¢ University of Embu alumni\nID required for all transactions. Using another person's ID is prohibited.",
    
    'id card': "ID requirements:\nâ€¢ Must present valid University of Embu ID card\nâ€¢ Using another person's ID is PROHIBITED\nâ€¢ Only card owner can borrow items\nâ€¢ ID required for all circulation transactions",
    
    # ============ PROCEDURES ============
    'how do i borrow a book': "Borrowing process:\n1. Take item (book, DVD, CD) to circulation desk\n2. Present valid University of Embu ID card\n3. Staff will issue the item\n4. Check due date stamp inside book cover for return date",
    
    'how to renew books': "Renewal process:\n1. Present the book and your ID at circulation desk\n2. Must be done BEFORE due date\n3. New due date calculated from renewal day\n\nCannot renew if:\nâ€¢ Item is overdue and accruing fines\nâ€¢ Item is on hold for another user\nâ€¢ Item has been recalled\nâ€¢ Maximum renewal limit reached (1 renewal only)",
    
    'lost a book': "Lost items procedure:\n1. Report loss IMMEDIATELY to librarian at circulation desk\n2. Library assists with searches for 1 month\n3. If not found after 1 month:\n   â€¢ Item declared lost\n   â€¢ Pay for replacement\n   â€¢ Pay Ksh 500 processing fee\n\nTo stop fines: Report loss immediately. Fines stop accruing from report date.",
    
    'book not on shelf': "If book shows available but not on shelf:\n1. Check reading tables near shelves\n2. May be recently returned (awaiting reshelving)\n3. Ask circulation desk for help locating\n4. Another user may be consulting it",
    
    # ============ LIBRARY ORGANIZATION ============
    'where are books located': "Library organization by floor:\nâ€¢ Ground Floor (A-L): General works, Philosophy, History, Social Sciences, Education\nâ€¢ First Floor: Political Science, Law\nâ€¢ Second Floor (Q-Z): Science, Medicine, Agriculture, Technology, Military Science",
    
    'library floors': "Floor layout:\nâ€¢ Ground: Classes A-L (General works to Education)\nâ€¢ First: Classes J-K (Political Science, Law)\nâ€¢ Second: Classes Q-Z (Science to Library Science)",
    
    'find books': "Finding books process:\n1. Search OPAC for book title/author\n2. Note call number (e.g., QA76.73)\n3. Go to appropriate floor by LC class\n4. Find shelf by alphabetical/numerical order",
    
    'opac': "OPAC (Online Public Access Catalogue) lets you:\nâ€¢ Search books by title, author, subject, keyword\nâ€¢ Check availability status (on shelf or on loan)\nâ€¢ View call numbers and location\nâ€¢ Reserve or renew items (where enabled)",
    
    # ============ CIRCULATION DESK ============
    'circulation desk': "Circulation desk services:\nâ€¢ Book borrowing and returns\nâ€¢ University ID verification and registration\nâ€¢ Renewals and reservations\nâ€¢ Overdue fine payments and inquiries\nâ€¢ Lost or damaged item reporting\nâ€¢ Borrower record updates and corrections",
    
    # ============ REFERENCING TOOLS ============
    'referencing tools': "Recommended reference management tools:\nâ€¢ Mendeley: Free PDF manager, reference manager, academic network\nâ€¢ Zotero: Collect, organize, cite, and share research sources\nâ€¢ EndNote: Advanced reference management (paid)",
    
    # ============ ACADEMIC INTEGRITY ============
    'academic integrity': "University of Embu Academic Integrity Policy:\nâ€¢ Plagiarism is academic misconduct\nâ€¢ Penalties range from failing assignment to expulsion\nâ€¢ All work must be original or properly cited\nâ€¢ Students responsible for understanding plagiarism\n\nPenalties:\nâ€¢ Minor offenses: Warning, revision, grade reduction\nâ€¢ Moderate offenses: Failing grade, academic probation\nâ€¢ Major offenses: Course failure, suspension, expulsion",
}

def get_specialized_answer(question: str) -> str:
    """Handle specific question patterns with detailed answers"""
    question_lower = question.lower()
    
    # ============ DEFINITION QUESTIONS ============
    # Check for "what is" questions first
    if question_lower.startswith('what is') or question_lower.startswith('define'):
        # Extract the term after "what is" or "define"
        term = question_lower.replace('what is', '').replace('define', '').strip()
        
        # Map common terms to definitions
        definition_map = {
            'plagiarism': 'what is plagiarism',
            'referencing': 'what is referencing',
            'citation': 'what is citation',
            'turnitin': 'what is turnitin',
            'apa': 'what is apa',
            'opac': 'what is opac',
            'library circulation': 'what is library circulation',
            'e-resource': 'what is e-resource',
            'electronic resource': 'what is e-resource',
            'myloft': 'what is myloft',
            'library classification': 'what is library classification',
            'academic integrity': 'what is academic integrity',
            'similarity report': 'what is similarity report',
            'reference list': 'what is reference list',
            'in-text citation': 'what is in-text citation',
            'circulation desk': 'what is circulation desk',
            'open access': 'what is open access',
            'anti-plagiarism': 'what is turnitin',
            'plagiarism software': 'what is turnitin',
        }
        
        # Check for exact term match
        for key, answer_key in definition_map.items():
            if key in term:
                return DIRECT_ANSWERS.get(answer_key, DIRECT_ANSWERS['what is plagiarism'])
        
        # Check for partial matches
        if 'plagiarism' in term:
            return DIRECT_ANSWERS['what is plagiarism']
        elif 'reference' in term or 'citation' in term:
            return DIRECT_ANSWERS['what is referencing']
        elif 'turnitin' in term or 'anti-plagiarism' in term:
            return DIRECT_ANSWERS['what is turnitin']
        elif 'apa' in term:
            return DIRECT_ANSWERS['what is apa']
        elif 'opac' in term or 'catalogue' in term:
            return DIRECT_ANSWERS['what is opac']
        elif 'e-resource' in term or 'electronic' in term:
            return DIRECT_ANSWERS['what is e-resource']
        elif 'myloft' in term:
            return DIRECT_ANSWERS['what is myloft']
        elif 'circulation' in term:
            if 'desk' in term:
                return DIRECT_ANSWERS['what is circulation desk']
            else:
                return DIRECT_ANSWERS['what is library circulation']
    
    # ============ BORROWING CATEGORY DETECTION ============
    if any(word in question_lower for word in ['borrow', 'loan', 'check out', 'take out']):
        if 'undergraduate' in question_lower:
            return DIRECT_ANSWERS['how many books can undergraduate students borrow']
        elif 'postgraduate' in question_lower or 'graduate' in question_lower:
            return DIRECT_ANSWERS['how many books can postgraduate students borrow']
        elif 'academic staff' in question_lower or ('academic' in question_lower and 'staff' in question_lower):
            return DIRECT_ANSWERS['how many books can academic staff borrow']
        elif 'non-academic' in question_lower or 'non academic' in question_lower:
            return DIRECT_ANSWERS['how many books can non-academic staff borrow']
        elif 'part-time' in question_lower or 'part time' in question_lower or 'lecturer' in question_lower:
            return DIRECT_ANSWERS['how many books can part-time lecturers borrow']
        elif 'student' in question_lower:
            return DIRECT_ANSWERS['how many books can undergraduate students borrow']
        elif 'staff' in question_lower:
            return DIRECT_ANSWERS['how many books can academic staff borrow']
    
    # ============ TURNITIN/SOFTWARE QUESTIONS ============
    software_keywords = ['software', 'tool', 'system', 'application', 'program', 'checker', 'detection', 'detect']
    plagiarism_keywords = ['plagiarism', 'cheating', 'academic dishonesty', 'similarity', 'anti-plagiarism']
    
    has_software = any(word in question_lower for word in software_keywords)
    has_plagiarism = any(word in question_lower for word in plagiarism_keywords)
    has_turnitin = 'turnitin' in question_lower
    
    if (has_software and has_plagiarism) or has_turnitin:
        if 'how' in question_lower and 'work' in question_lower:
            return DIRECT_ANSWERS['how does turnitin work']
        elif 'similarity' in question_lower or 'report' in question_lower:
            return DIRECT_ANSWERS['similarity report']
        else:
            return DIRECT_ANSWERS['plagiarism software']
    
    # ============ LIBRARY HOURS VARIATIONS ============
    hour_keywords = ['open', 'close', 'hour', 'time', 'when', 'schedule']
    library_keywords = ['library', 'opening', 'closing']
    
    if any(word in question_lower for word in hour_keywords) and any(word in question_lower for word in library_keywords):
        if 'close' in question_lower or 'closing' in question_lower:
            return DIRECT_ANSWERS['library closing time']
        else:
            return DIRECT_ANSWERS['what time does the library open']
    
    # ============ APA REFERENCING VARIATIONS ============
    if any(word in question_lower for word in ['apa', 'reference', 'cite', 'citation']):
        if 'how' in question_lower or 'format' in question_lower:
            return DIRECT_ANSWERS['how do i reference using apa format']
        else:
            return DIRECT_ANSWERS['apa referencing']
    
    # ============ E-RESOURCES VARIATIONS ============
    if any(word in question_lower for word in ['e-resource', 'electronic resource', 'database', 'online resource']):
        if 'past paper' in question_lower or 'exam' in question_lower:
            return DIRECT_ANSWERS['past exam papers']
        elif 'myloft' in question_lower or 'app' in question_lower:
            return DIRECT_ANSWERS['myloft']
        else:
            return DIRECT_ANSWERS['how do i access e-resources']
    
    # ============ MEMBERSHIP VARIATIONS ============
    if any(word in question_lower for word in ['join', 'membership', 'register', 'id card', 'student card']):
        if 'id' in question_lower or 'card' in question_lower:
            return DIRECT_ANSWERS['id card']
        else:
            return DIRECT_ANSWERS['how do i join the library']
    
    # ============ PROCEDURE QUESTIONS ============
    if any(word in question_lower for word in ['how to', 'how do i', 'procedure', 'process', 'steps']):
        if 'borrow' in question_lower or 'check out' in question_lower:
            return DIRECT_ANSWERS['how do i borrow a book']
        elif 'renew' in question_lower:
            return DIRECT_ANSWERS['how to renew books']
        elif 'lost' in question_lower or 'misplace' in question_lower:
            return DIRECT_ANSWERS['lost a book']
        elif 'find' in question_lower or 'locate' in question_lower or 'where is' in question_lower:
            return DIRECT_ANSWERS['find books']
    
    # ============ LIBRARY ORGANIZATION ============
    if any(word in question_lower for word in ['floor', 'shelf', 'location', 'where', 'find', 'opac', 'catalogue']):
        if 'floor' in question_lower:
            return DIRECT_ANSWERS['library floors']
        elif 'opac' in question_lower or 'catalogue' in question_lower:
            return DIRECT_ANSWERS['opac']
        else:
            return DIRECT_ANSWERS['where are books located']
    
    return None

def get_direct_answer(question: str) -> str:
    """Get direct answer from database with intelligent matching"""
    question_lower = question.lower().strip()
    
    # First check specialized answers (handles complex patterns)
    specialized = get_specialized_answer(question)
    if specialized:
        return specialized
    
    # Exact match
    if question_lower in DIRECT_ANSWERS:
        return DIRECT_ANSWERS[question_lower]
    
    # Check for multi-word exact matches
    for key in DIRECT_ANSWERS.keys():
        if key in question_lower:
            return DIRECT_ANSWERS[key]
    
    # Simple keyword matching for common patterns
    if 'borrow' in question_lower:
        if 'how many' in question_lower or 'limit' in question_lower:
            return DIRECT_ANSWERS['how many books can i borrow']
        elif 'how to' in question_lower or 'how do' in question_lower:
            return DIRECT_ANSWERS['how do i borrow a book']
    
    if 'fine' in question_lower or 'overdue' in question_lower:
        return DIRECT_ANSWERS['what is the fine for overdue books']
    
    if 'plagiarism' in question_lower:
        return DIRECT_ANSWERS['what is plagiarism']
    
    if 'turnitin' in question_lower:
        return DIRECT_ANSWERS['turnitin']
    
    if 'apa' in question_lower:
        return DIRECT_ANSWERS['apa referencing']
    
    if 'hour' in question_lower or 'open' in question_lower:
        return DIRECT_ANSWERS['what time does the library open']
    
    if 'e-resource' in question_lower or 'electronic' in question_lower:
        return DIRECT_ANSWERS['how do i access e-resources']
    
    if 'past paper' in question_lower or 'exam paper' in question_lower:
        return DIRECT_ANSWERS['past exam papers']
    
    if 'join' in question_lower or 'membership' in question_lower:
        return DIRECT_ANSWERS['how do i join the library']
    
    if 'lost' in question_lower:
        return DIRECT_ANSWERS['lost a book']
    
    if 'renew' in question_lower:
        return DIRECT_ANSWERS['how to renew books']
    
    if 'circulation' in question_lower:
        return DIRECT_ANSWERS['circulation desk']
    
    # Definition fallback
    if question_lower.startswith('what is') or question_lower.startswith('define'):
        return DIRECT_ANSWERS['what is plagiarism']
    
    return None

class StrictRAGSystem:
    """RAG system that ONLY uses provided context"""
    
    def __init__(self):
        from app.core.vector_store import VectorStore
        from app.core.llm_client import SimpleLLMClient
        
        self.vector_store = VectorStore()
        self.llm_client = SimpleLLMClient()
        
        # Load vector store
        self.vector_store.load()
        logger.info(f"Strict RAG loaded with {len(self.vector_store.chunks)} chunks")
    
    def search_exact_chunks(self, question: str) -> List[Dict[str, Any]]:
        """Search for chunks that exactly match the question"""
        question_lower = question.lower()
        
        # Get keywords from question
        keywords = []
        for word in re.findall(r'\b\w+\b', question_lower):
            if len(word) > 3 and word not in ['what', 'how', 'when', 'where', 'which', 'does', 'do', 'are', 'is', 'the', 'and', 'for', 'can', 'i', 'me', 'my', 'define']:
                keywords.append(word)
        
        # If no good keywords, use the whole question
        if not keywords:
            keywords = [word for word in question_lower.split() if len(word) > 3]
        
        # Search for exact matches
        exact_matches = []
        for chunk in self.vector_store.chunks:
            text = chunk.get('text', '').lower()
            metadata = chunk.get('metadata', {})
            
            # Check for exact keyword matches
            match_count = 0
            for keyword in keywords:
                if keyword in text:
                    match_count += 1
            
            # Also check content type
            content_type = metadata.get('content_type', '')
            if 'borrow' in question_lower and content_type == 'borrowing':
                match_count += 2
            if 'plagiarism' in question_lower and content_type == 'academic_integrity':
                match_count += 2
            if 'apa' in question_lower and content_type == 'referencing':
                match_count += 2
            
            if match_count >= 1:  # Lower threshold to get more results
                chunk['match_score'] = match_count
                exact_matches.append(chunk)
        
        # Sort by match score
        exact_matches.sort(key=lambda x: x.get('match_score', 0), reverse=True)
        return exact_matches[:15]  # Get more chunks
    
    def create_strict_context(self, chunks: List[Dict[str, Any]]) -> str:
        """Create context with clear instructions"""
        if not chunks:
            return "NO_CONTEXT_AVAILABLE"
        
        context_parts = []
        used_texts = set()
        
        for chunk in chunks:
            text = chunk.get('text', '').strip()
            source = chunk.get('metadata', {}).get('source', 'Document')
            
            # Deduplicate similar texts
            text_hash = hash(text[:100])
            if text_hash in used_texts:
                continue
            used_texts.add(text_hash)
            
            if text and len(text) > 30:
                # Clean and format
                text = re.sub(r'\s+', ' ', text)  # Remove extra whitespace
                text = text[:800]  # Increased limit for more context
                
                context_parts.append(f"[FROM: {source}]\n{text}")
        
        return "\n\n" + "\n---\n".join(context_parts[:8])  # More context parts
    
    def generate_strict_answer(self, question: str, context: str) -> str:
        """Generate answer with STRICT instructions"""
        if context == "NO_CONTEXT_AVAILABLE":
            # Try to give a helpful generic answer
            if 'borrow' in question.lower():
                return "I couldn't find specific borrowing information. Please ask: 'How many books can undergraduate students borrow?' or specify your category (undergraduate, postgraduate, staff, etc.)"
            elif 'what is' in question.lower() or 'define' in question.lower():
                return "I couldn't find a specific definition. Please ask about: plagiarism, referencing, citation, Turnitin, APA, OPAC, e-resources, or library circulation."
            return "The documents do not contain specific information about this. Please check the library documents or ask a librarian."
        
        # VERY STRICT prompt
        prompt = f"""You are a library assistant at University of Embu. Answer the question using ONLY the information provided below.

IMPORTANT RULES:
1. Use ONLY information from the context below
2. Do NOT add any information not found in the context
3. If the answer is not in the context, say: "Based on the documents, I don't have specific information about this."
4. Be specific and accurate
5. Include numbers, dates, amounts when available

CONTEXT FROM LIBRARY DOCUMENTS:
{context}

QUESTION: {question}

ANSWER (based only on context above):"""
        
        try:
            answer = self.llm_client.generate_context_only_answer(question, context)
            
            # Clean up the answer
            answer = answer.strip()
            
            # Check if answer is useful
            if not answer or len(answer) < 20:
                return "Based on the documents, I don't have specific information about this."
            
            # Remove any "Answer:" prefixes
            answer = re.sub(r'^(Answer|Based on|According to)[:\s]*', '', answer, flags=re.IGNORECASE)
            
            return answer
            
        except Exception as e:
            logger.error(f"Error generating answer: {e}")
            return "System error. Please try again."
    
    def get_strict_answer(self, question: str) -> str:
        """Get strict context-only answer"""
        if not question.strip():
            return "Please enter a question about the University of Embu Library."
        
        logger.info(f"Strict RAG processing: {question}")
        
        # Special handling for definition questions
        question_lower = question.lower()
        if question_lower.startswith('what is') or question_lower.startswith('define'):
            # Force search for definition information
            definition_chunks = []
            for chunk in self.vector_store.chunks:
                text = chunk.get('text', '').lower()
                # Look for definition patterns
                if 'is defined as' in text or 'means' in text or 'refers to' in text or 'definition' in text:
                    definition_chunks.append(chunk)
            
            if definition_chunks:
                context = self.create_strict_context(definition_chunks[:10])
                return self.generate_strict_answer(question, context)
        
        # Special handling for borrowing questions
        if 'borrow' in question_lower and ('how many' in question_lower or 'can i' in question_lower):
            # Force search for borrowing information
            borrowing_chunks = []
            for chunk in self.vector_store.chunks:
                text = chunk.get('text', '').lower()
                if 'borrow' in text or 'loan' in text:
                    borrowing_chunks.append(chunk)
            
            if borrowing_chunks:
                context = self.create_strict_context(borrowing_chunks[:10])
                return self.generate_strict_answer(question, context)
        
        # Normal search
        relevant_chunks = self.search_exact_chunks(question)
        logger.info(f"Found {len(relevant_chunks)} relevant chunks")
        
        # Create context
        context = self.create_strict_context(relevant_chunks)
        
        # Generate answer
        answer = self.generate_strict_answer(question, context)
        
        # Add sources if we have them
        if relevant_chunks and "don't have specific information" not in answer.lower():
            sources = set()
            for chunk in relevant_chunks[:3]:
                source = chunk.get('metadata', {}).get('source', '')
                if source:
                    # Clean source name
                    source = source.replace('.pdf', '').replace('â€“', '-').replace(' University of Embu Library', '')
                    sources.add(source)
            
            if sources:
                answer += f"\n\nðŸ“š Source: {', '.join(sorted(sources))}"
        
        return answer

# Global instance
_strict_rag_instance = None

def get_strict_response(question: str) -> str:
    """Get strict response"""
    global _strict_rag_instance
    try:
        # First try direct answers
        direct = get_direct_answer(question)
        if direct:
            return direct
        
        # Then use RAG
        if _strict_rag_instance is None:
            _strict_rag_instance = StrictRAGSystem()
        
        return _strict_rag_instance.get_strict_answer(question)
    except Exception as e:
        logger.error(f"Error in get_strict_response: {e}")
        return "System error. Please try again."
